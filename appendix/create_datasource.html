<html>
<head>
<title>如何创建 DataSource</title>
</head>
<body><a name="top"></a>
<div class="zdoc_header">如何创建 DataSource</div>
<div class="zdoc_author"><em>By:</em><b>zozoh</b><a href="mailto:zozohtnt@gmail.com">&lt;zozohtnt@gmail.com&gt;</a><b>wendal</b><a href="mailto:wendal1985@gmail.com">&lt;wendal1985@gmail.com&gt;</a></div>
<div class="zdoc_body">
<div class="hr"><b></b></div>
<h1>内置的SimpleDataSource</h1>
<h2>Nutz内置,非常适合新手!!</h2>
<ul type="disc">
<li>自动加载NutDao所支持的数据库的驱动</li>
<li>无额外依赖,适合新手试用</li>
<li>非连接池,配置简单</li>
<li>不建议在生产环境使用</li>
<li>1.b.43开始提供,旧版本的Nutz可通过拷贝源文件的方式添加这个类</li>
</ul>
<h2>SimpleDataSource: 直接书写 Java 代码</h2>
<pre>import org.nutz.dao.impl.SimpleDataSource;

...

SimpleDataSource ds = new SimpleDataSource();
<span class="zdoc_code_cmt">//ds.setDriverClassName("org.postgresql.Driver"); //默认加载了大部分数据库的驱动!!
</span>ds.setjdbcUrl("jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase");
</span>ds.setUsername("demo");
ds.setPassword("123456");
...
<span class="zdoc_code_cmt">//ds.close();  // 这个DataSource不是一个连接池,所以关不关都行
</span></pre>
<h2>SimpleDataSource: 通过 Nutz.Ioc 的 JSON 配置文件</h2>
<pre>{
	dataSource : {
		type : "org.nutz.dao.impl.SimpleDataSource",
		fields : {
			jdbcUrl : 'jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase',
</span>			username : 'demo',
			password : '123456'
		}
	}
}
</pre>
<h2>SimpleDataSource: 通过 Nutz.Ioc 的 XML 配置文件</h2>
<pre>	&lt;ioc xsi:noNamespaceSchemaLocation="nutz-ioc-0.1.xsd"&gt;
		&lt;obj name="dataSource" type="org.nutz.dao.impl.SimpleDataSource"&gt;
			&lt;field name="jdbcUrl"&gt;&lt;str&gt;jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase&lt;/str&gt;&lt;/field&gt;
</span>			&lt;field name="username"&gt;&lt;str&gt;demo&lt;/str&gt;&lt;/field&gt;
			&lt;field name="password"&gt;&lt;str&gt;123456&lt;/str&gt;&lt;/field&gt;
		&lt;/obj&gt;
	&lt;/ioc&gt;
</pre>
<h2>附送一个完整的NutDao配置js文件</h2>
<pre>var ioc = {
	dao : {
		type : "org.nutz.dao.impl.NutDao",
		args : [{refer:"dataSource"}]
	},
	dataSource : {
		type : "org.nutz.dao.impl.SimpleDataSource",
		fields : {
			jdbcUrl : 'jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase',
</span>			username : 'demo',
			password : '123456'
		}
	}
}
</pre>
<div class="hr"><b></b></div>
<h1>Apache Tomcat 7 连接池</h1>
<p>这里使用的是tomcat7新的自带连接,但是,请把其2个jar移到项目的lib中!!</p>
<h2>直接书写 Java 代码</h2>
<pre>import org.apache.tomcat.jdbc.pool.DataSource;

...

DataSource ds = new DataSource();
ds.setDriverClassName("org.postgresql.Driver");
ds.setUrl("jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase");
</span>ds.setUsername("demo");
ds.setPassword("123456");
...
ds.close();  <span class="zdoc_code_cmt">// 关闭池内所有连接
</span></pre>
<h2>通过 Nutz.Ioc 的 JSON 配置文件</h2>
<pre>{
	dataSource : {
		type : "org.apache.tomcat.jdbc.pool.DataSource",
		events : {
			depose : 'close'
		},
		fields : {
			driverClassName : 'org.postgresql.Driver',
			url : 'jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase',
</span>			username : 'demo',
			password : '123456'
		}
	}
}
</pre>
<h2>通过 Nutz.Ioc 的 XML 配置文件</h2>
<pre>	&lt;ioc xsi:noNamespaceSchemaLocation="nutz-ioc-0.1.xsd"&gt;
		&lt;obj name="dataSource" type="org.apache.tomcat.jdbc.pool.DataSource"&gt;
			&lt;events&gt;
				&lt;depose&gt;close&lt;/depose&gt;
			&lt;/events&gt;
			&lt;field name="driverClassName"&gt;&lt;str&gt;org.postgresql.Driver&lt;/str&gt;&lt;/field&gt;
			&lt;field name="url"&gt;&lt;str&gt;jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase&lt;/str&gt;&lt;/field&gt;
</span>			&lt;field name="username"&gt;&lt;str&gt;demo&lt;/str&gt;&lt;/field&gt;
			&lt;field name="password"&gt;&lt;str&gt;123456&lt;/str&gt;&lt;/field&gt;
		&lt;/obj&gt;
	&lt;/ioc&gt;
</pre>
<ul type="disc">
<li>注册了 depose 事件，当整个 Ioc 容器注销时，将 <b>真正 </b>  关闭所有池内连接</li>
<li>关于 depose 事件，更多详情请参看 <a href="#ioc/events.html">事件监听</a></li>
</ul>
<div class="hr"><b></b></div>
<h1>Apache DBCP</h1>
<h2>dbcp: 直接书写 Java 代码</h2>
<pre>import org.apache.commons.dbcp.BasicDataSource;

...

BasicDataSource ds = new BasicDataSource();
ds.setDriverClassName("org.postgresql.Driver");
ds.setUrl("jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase");
</span>ds.setUsername("demo");
ds.setPassword("123456");
...
ds.close();  <span class="zdoc_code_cmt">// 关闭池内所有连接
</span></pre>
<h2>dbcp: 通过 Nutz.Ioc 的 JSON 配置文件</h2>
<pre>{
	dataSource : {
		type : "org.apache.commons.dbcp.BasicDataSource",
		events : {
			depose : 'close'
		},
		fields : {
			driverClassName : 'org.postgresql.Driver',
			url : 'jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase',
</span>			username : 'demo',
			password : '123456'
		}
	}
}
</pre>
<h2>dbcp: 通过 Nutz.Ioc 的 XML 配置文件</h2>
<pre>	&lt;ioc xsi:noNamespaceSchemaLocation="nutz-ioc-0.1.xsd"&gt;
		&lt;obj name="dataSource" type="org.apache.commons.dbcp.BasicDataSource"&gt;
			&lt;events&gt;
				&lt;depose&gt;close&lt;/depose&gt;
			&lt;/events&gt;
			&lt;field name="driverClassName"&gt;&lt;str&gt;org.postgresql.Driver&lt;/str&gt;&lt;/field&gt;
			&lt;field name="url"&gt;&lt;str&gt;jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase&lt;/str&gt;&lt;/field&gt;
</span>			&lt;field name="username"&gt;&lt;str&gt;demo&lt;/str&gt;&lt;/field&gt;
			&lt;field name="password"&gt;&lt;str&gt;123456&lt;/str&gt;&lt;/field&gt;
		&lt;/obj&gt;
	&lt;/ioc&gt;
</pre>
<ul type="disc">
<li>注册了 depose 事件，当整个 Ioc 容器注销时，将 <b>真正 </b>  关闭所有池内连接</li>
<li>关于 depose 事件，更多详情请参看 <a href="#ioc/events.html">事件监听</a></li>
</ul>
<div class="hr"><b></b></div>
<h1>C3P0</h1>
<h2>c3p0: 直接书写 Java 代码</h2>
<pre>import com.mchange.v2.c3p0.ComboPooledDataSource;

...

ComboPooledDataSource ds = new ComboPooledDataSource();
ds.setDriverClass("org.postgresql.Driver");
ds.setJdbcUrl("jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase");
</span>ds.setUser("demo");
ds.setPassword("123456");
...
ds.close();  <span class="zdoc_code_cmt">// 关闭池内所有连接
</span></pre>
<h2>c3p0: 通过 Nutz.Ioc 的 JSON 配置文件</h2>
<pre>{
	dataSource : {
		type : "com.mchange.v2.c3p0.ComboPooledDataSource",
		events : {
			depose : 'close'
		},
		fields : {
			driverClass : 'org.postgresql.Driver',
			jdbcUrl : 'jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase',
</span>			user : 'demo',
			password : '123456'
		}
	}
}
</pre>
<h2>c3p0: 通过 Nutz.Ioc 的 XML 配置文件</h2>
<pre>	&lt;ioc xsi:noNamespaceSchemaLocation="nutz-ioc-0.1.xsd"&gt;
		&lt;obj name="dataSource" type="com.mchange.v2.c3p0.ComboPooledDataSource"&gt;
			&lt;events&gt;
				&lt;depose&gt;close&lt;/depose&gt;
			&lt;/events&gt;
			&lt;field name="driverClass"&gt;&lt;str&gt;org.postgresql.Driver&lt;/str&gt;&lt;/field&gt;
			&lt;field name="jdbcUrl"&gt;&lt;str&gt;jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase&lt;/str&gt;&lt;/field&gt;
</span>			&lt;field name="user"&gt;&lt;str&gt;demo&lt;/str&gt;&lt;/field&gt;
			&lt;field name="password"&gt;&lt;str&gt;123456&lt;/str&gt;&lt;/field&gt;
		&lt;/obj&gt;
	&lt;/ioc&gt;
</pre>
<ul type="disc">
<li>注册了 depose 事件，当整个 Ioc 容器注销时，将 <b>真正 </b>  关闭所有池内连接</li>
</ul>
<div class="hr"><b></b></div>
<h1>Proxool</h1>
<h2>proxool: 直接书写 Java 代码</h2>
<pre>import org.logicalcobwebs.proxool.ProxoolDataSource;

...

ProxoolDataSource ds = new ProxoolDataSource();
ds.setDriver("org.postgresql.Driver");
ds.setDriverUrl("jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase");
</span>ds.setUser("demo");
ds.setPassword("123456");
...
</pre>
<h2>proxool: 通过 Nutz.Ioc 的 JSON 配置文件</h2>
<pre>{
	dataSource : {
		type : "org.logicalcobwebs.proxool.ProxoolDataSource",
		fields : {
			driver : 'org.postgresql.Driver',
			driverUrl : 'jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase',
</span>			user : 'demo',
			password : '123456'
		}
	}
}
</pre>
<h2>proxool: 通过 Nutz.Ioc 的 XML 配置文件</h2>
<pre>	&lt;ioc xsi:noNamespaceSchemaLocation="nutz-ioc-0.1.xsd"&gt;
		&lt;obj name="dataSource" type="org.logicalcobwebs.proxool.ProxoolDataSource"&gt;
			&lt;field name="driver"&gt;&lt;str&gt;org.postgresql.Driver&lt;/str&gt;&lt;/field&gt;
			&lt;field name="driverUrl"&gt;&lt;str&gt;jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase&lt;/str&gt;&lt;/field&gt;
</span>			&lt;field name="user"&gt;&lt;str&gt;demo&lt;/str&gt;&lt;/field&gt;
			&lt;field name="password"&gt;&lt;str&gt;123456&lt;/str&gt;&lt;/field&gt;
		&lt;/obj&gt;
	&lt;/ioc&gt;
</pre>
<ul type="disc">
<li>Proxool 没有提供关闭所有连接的函数，不过你可以参看它的官方文档，自己写一个释放所有连接的类，配置在 Ioc 容器的 depose 事件中</li>
<li>关于 depose 事件，更多详情请参看 <a href="#ioc/events.html">事件监听</a> - <b>通过实现一个触发器</b></li>
</ul>
<div class="hr"><b></b></div>
<h1>BoneCP</h1>
<h2>bonecp: 直接书写 Java 代码</h2>
<pre>import com.jolbox.bonecp.BoneCPDataSource;

...

BoneCPDataSource ds = new BoneCPDataSource();
ds.setDriver("org.postgresql.Driver");
ds.setJdbcUrl("jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase");
</span>ds.setUsername("demo");
ds.setPassword("123456");
...
</pre>
<h2>bonecp: 通过 Nutz.Ioc 的 JSON 配置文件</h2>
<pre>{
	dataSource : {
		type : "com.jolbox.bonecp.BoneCPDataSource",
		events : {
			depose : 'close'
		},
		fields : {
			driverClass : 'org.postgresql.Driver',
			jdbcUrl : 'jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase',
</span>			username : 'demo',
			password : '123456'
		}
	}
}
</pre>
<h2>bonecp: 通过 Nutz.Ioc 的 XML 配置文件</h2>
<pre>	&lt;ioc xsi:noNamespaceSchemaLocation="nutz-ioc-0.1.xsd"&gt;
		&lt;obj name="dataSource" type="com.jolbox.bonecp.BoneCPDataSource"&gt;
			&lt;events&gt;
				&lt;depose&gt;close&lt;/depose&gt;
			&lt;/events&gt;
			&lt;field name="driverClass"&gt;&lt;str&gt;org.postgresql.Driver&lt;/str&gt;&lt;/field&gt;
			&lt;field name="url"&gt;&lt;str&gt;jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase&lt;/str&gt;&lt;/field&gt;
</span>			&lt;field name="username"&gt;&lt;str&gt;demo&lt;/str&gt;&lt;/field&gt;
			&lt;field name="password"&gt;&lt;str&gt;123456&lt;/str&gt;&lt;/field&gt;
		&lt;/obj&gt;
	&lt;/ioc&gt;
</pre>
<ul type="disc">
<li>注册了 depose 事件，当整个 Ioc 容器注销时，将 <b>真正 </b>  关闭所有池内连接</li>
</ul>
<div class="hr"><b></b></div>
<h1>如何使用这些配置</h1>
<h2>Java代码的方式:</h2>
<pre><span class="zdoc_code_cmt">//创建dataSource,以DBCP为例
</span>DataSource ds = new DataSource();
ds.setDriverClassName("org.postgresql.Driver");
ds.setUrl("jdbc:postgresql:<span class="zdoc_code_cmt">//localhost:5432/mydatabase");
</span>ds.setUsername("demo");
ds.setPassword("123456");
Dao dao = new NutDao(ds);

dao.create(User.class, true);
dao.insert(User.create("wendal","123456"));

<span class="zdoc_code_cmt">//.... ... ...
</span>
<span class="zdoc_code_cmt">//所有操作都已经完成,关闭连接池,退出系统
</span>ds.close();
return;

<span class="zdoc_code_cmt">//额外提醒,NutDao是线程安全的,请不要多次创建NutDao,除非你有多个DataSource
</span></pre>
<h2>通过 Nutz.Ioc 的 JSON 配置文件</h2>
<pre><span class="zdoc_code_cmt">//将配置信息保存到dao.js,并存放于src文件夹下
</span>
Ioc ioc = new NutIoc(new JsonLoader("dao.js"));
DataSource ds = ioc.get(DataSource.class);
Dao dao = new NutDao(ds); <span class="zdoc_code_cmt">//如果已经定义了dao,那么改成dao = ioc.get(Dao.class);
</span>
dao.create(User.class, true);
dao.insert(User.create("wendal","123456"));

ioc.depose(); <span class="zdoc_code_cmt">//关闭Ioc容器
</span></pre>
<h2>通过 Nutz.Ioc 的 XML 配置文件</h2>
<pre><span class="zdoc_code_cmt">//将配置信息保存到dao.xml,并存放于src文件夹下
</span>
Ioc ioc = new NutIoc(new XmlIocLoader("dao.js"));
DataSource ds = ioc.get(DataSource.class);
Dao dao = new NutDao(ds); <span class="zdoc_code_cmt">//如果已经定义了dao,那么改成dao = ioc.get(Dao.class);
</span>
dao.create(User.class, true);
dao.insert(User.create("wendal","123456"));

ioc.depose(); <span class="zdoc_code_cmt">//关闭Ioc容器
</span></pre>
</div>
<div class="zdoc_footer"><em>By:</em><b>zozoh</b><a href="mailto:zozohtnt@gmail.com">&lt;zozohtnt@gmail.com&gt;</a><b>wendal</b><a href="mailto:wendal1985@gmail.com">&lt;wendal1985@gmail.com&gt;</a></div>
</body>
</html>